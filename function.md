# ğŸ”§ Douyin Video Downloader - å®Œæ•´æŠ€æœ¯æ–‡æ¡£

> **æœ€åæ›´æ–°:** 2026å¹´2æœˆ13æ—¥  
> **ç‰ˆæœ¬:** v2026.2.12 
> **æ–‡ä»¶:** 678è¡Œ(bin/index.js) + 1030è¡Œ(src/index.js) + 2819è¡Œ(public/script.js)

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
2. [åç«¯æ ¸å¿ƒç±»](#åç«¯æ ¸å¿ƒç±»)
3. [å‰ç«¯æ ¸å¿ƒç±»](#å‰ç«¯æ ¸å¿ƒç±»)
4. [APIç«¯ç‚¹è¯¦è§£](#api-ç«¯ç‚¹è¯¦è§£)
5. [å·¥å…·å‡½æ•°åº“](#å·¥å…·å‡½æ•°åº“)
6. [æ€§èƒ½ä¼˜åŒ–æœºåˆ¶](#æ€§èƒ½ä¼˜åŒ–æœºåˆ¶)
7. [Cookieç®¡ç†ç³»ç»Ÿ](#cookie-ç®¡ç†ç³»ç»Ÿ)
8. [è°ƒè¯•å·¥ä½œæµ](#è°ƒè¯•å·¥ä½œæµ)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### é«˜å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client (Browser/App)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Frontend (public/script.js - 2819 lines)                â”‚  â”‚
â”‚  â”‚  â€¢ DownloadManager - ä¸‹è½½é˜Ÿåˆ—ç®¡ç†                         â”‚  â”‚
â”‚  â”‚  â€¢ DownloadUI - æ‰¹é‡ä¸‹è½½ç•Œé¢                              â”‚  â”‚
â”‚  â”‚  â€¢ CookieManager - CookieçŠ¶æ€ç›‘æ§                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP Requests
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Express.js Server (src/index.js - 1030 lines)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç¯å¢ƒæ£€æµ‹å±‚ (Environment Detection)                       â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨è¯†åˆ«: Local / Vercel                               â”‚  â”‚
â”‚  â”‚  â€¢ .env.local (æœ¬åœ°) / Env Vars (Vercel)                 â”‚  â”‚
â”‚  â”‚  â€¢ Cookie æœ‰æ•ˆæœŸéªŒè¯                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API è·¯ç”±å±‚ (12ä¸ªç«¯ç‚¹)                                    â”‚  â”‚
â”‚  â”‚  â€¢ /zjcdn - ä¸»è§£æç«¯ç‚¹ (æœ€ç¨³å®š)                           â”‚  â”‚
â”‚  â”‚  â€¢ /workflow - å¤‡ç”¨å¤šé‡å›é€€                               â”‚  â”‚
â”‚  â”‚  â€¢ /test-url, /check-url, /test-videoid - è°ƒè¯•ç«¯ç‚¹       â”‚  â”‚
â”‚  â”‚  â€¢ /api/update-cookie - CookieåŠ¨æ€æ›´æ–°                    â”‚  â”‚
â”‚  â”‚  â€¢ /api/cookie-status - çŠ¶æ€æ£€æŸ¥                          â”‚  â”‚
â”‚  â”‚  â€¢ /proxy-download, /proxy-video - ä»£ç†ä¸‹è½½              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¼˜åŒ–å±‚ (Optimization)                                    â”‚  â”‚
â”‚  â”‚  â€¢ RequestDeduplicator - è¯·æ±‚å»é‡                         â”‚  â”‚
â”‚  â”‚  â€¢ SimpleCache - TTLç¼“å­˜ (2åˆ†é’Ÿ)                          â”‚  â”‚
â”‚  â”‚  â€¢ PerformanceMonitor - æ€§èƒ½ç›‘æ§                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Scraper Module (bin/index.js - 678 lines)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ ¸å¿ƒçˆ¬è™«ç±» (Scraper Class)                               â”‚  â”‚
â”‚  â”‚  â€¢ getDouyinVideoId() - URLè§£æ â†’ Video ID               â”‚  â”‚
â”‚  â”‚  â€¢ getDouyinVideoData() - è·å–å…ƒæ•°æ®                      â”‚  â”‚
â”‚  â”‚  â€¢ getDouyinNoWatermarkVideo() - å¤šé‡å›é€€ç­–ç•¥             â”‚  â”‚
â”‚  â”‚    â”œâ”€ zjcdnç›´é“¾ (æœ€ä¼˜å…ˆ)                                  â”‚  â”‚
â”‚  â”‚    â”œâ”€ aweme.snssdk.com æ¥å£                               â”‚  â”‚
â”‚  â”‚    â””â”€ ixigua.com å›é€€                                     â”‚  â”‚
â”‚  â”‚  â€¢ updateCookie() - åŠ¨æ€æ›´æ–°Cookie                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å·¥å…·å‡½æ•°                                                  â”‚  â”‚
â”‚  â”‚  â€¢ maskSensitiveInfo() - æ•æ„Ÿä¿¡æ¯è„±æ•                     â”‚  â”‚
â”‚  â”‚  â€¢ checkSidGuardExpiry() - Cookieè¿‡æœŸæ£€æµ‹                 â”‚  â”‚
â”‚  â”‚  â€¢ formatRemainingTime() - æ—¶é—´æ ¼å¼åŒ–                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ åç«¯æ ¸å¿ƒç±»

### ğŸ“¦ æ–‡ä»¶: `src/index.js` (1030è¡Œ)

#### **1. PerformanceMonitor**

**åŠŸèƒ½:** ç›‘æ§APIç«¯ç‚¹æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨

**å±æ€§:**
- `metrics: Map<string, Object>` - å­˜å‚¨æ´»åŠ¨æµ‹é‡
- `enabled: boolean` - ç”± `ENABLE_PERF_MONITORING=1` æ§åˆ¶

**æ–¹æ³•:**
```javascript
start(label)           // å¼€å§‹ç›‘æ§æ“ä½œ
end(label)             // ç»“æŸç›‘æ§ï¼Œè¾“å‡ºæ—¥å¿—
clear()                // æ¸…ç©ºæ‰€æœ‰æŒ‡æ ‡
```

**ä½¿ç”¨ç¤ºä¾‹:**
```javascript
perfMonitor.start('zjcdn-api');
// ... æ‰§è¡Œæ“ä½œ
perfMonitor.end('zjcdn-api');  
// è¾“å‡º: â±ï¸ [zjcdn-api] Duration: 245ms, Memory: 1.23MB heap
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨**

---

#### **2. SimpleCache**

**åŠŸèƒ½:** å†…å­˜TTLç¼“å­˜ï¼Œå‡å°‘é‡å¤APIè°ƒç”¨

**å±æ€§:**
- `cache: Map<string, {value, expiry}>` - é”®å€¼å­˜å‚¨
- `ttl: number` - ç”Ÿå­˜æ—¶é—´ï¼ˆé»˜è®¤:120ç§’ï¼‰
- `cleanupStartIndex: number` - è½®è¯¢æ¸…ç†ä½ç½®

**æ–¹æ³•:**
```javascript
get(key)                    // è·å–ç¼“å­˜å€¼ï¼ˆè¿‡æœŸè¿”å›nullï¼‰
set(key, value)             // è®¾ç½®ç¼“å­˜å€¼
clear()                     // æ¸…ç©ºç¼“å­˜
startCleanup(interval)      // å¯åŠ¨å®šæœŸæ¸…ç†ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
stopCleanup()               // åœæ­¢æ¸…ç†
```

**æ¸…ç†ç­–ç•¥:**
- è½®è¯¢æ–¹å¼ï¼šæ¯æ¬¡æ£€æŸ¥50ä¸ªæ¡ç›®
- é˜²æ­¢å¤§å‹ç¼“å­˜é˜»å¡
- å®ä¾‹åŒ–æ—¶è‡ªåŠ¨å¯åŠ¨

**å®ä¾‹:**
```javascript
const videoDataCache = new SimpleCache(120000); // 2åˆ†é’ŸTTL
videoDataCache.startCleanup();
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - ç”¨äº `/zjcdn` ç«¯ç‚¹

---

#### **3. RequestDeduplicator**

**åŠŸèƒ½:** é˜²æ­¢ç›¸åŒèµ„æºçš„é‡å¤å¹¶å‘è¯·æ±‚

**å±æ€§:**
- `pending: Map<string, Promise>` - æ´»åŠ¨è¯·æ±‚Promise

**æ–¹æ³•:**
```javascript
execute(key, asyncFunction)  // æ‰§è¡Œæˆ–åŠ å…¥ç°æœ‰è¯·æ±‚
clear()                      // æ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†è¯·æ±‚
```

**å·¥ä½œæµç¨‹:**
```
è¯·æ±‚A: /zjcdn?url=X  â†’  åˆ›å»ºpromiseï¼Œå¼€å§‹è·å–
è¯·æ±‚B: /zjcdn?url=X  â†’  è¿”å›ç°æœ‰promiseï¼ˆæ— éœ€é‡å¤è¯·æ±‚ï¼‰
è¯·æ±‚C: /zjcdn?url=Y  â†’  åˆ›å»ºæ–°promiseï¼Œç‹¬ç«‹è·å–
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - ç”¨äº `/zjcdn` ç«¯ç‚¹

---

### ğŸ“¦ æ–‡ä»¶: `bin/index.js` (678è¡Œ)

#### **4. Scraper**

**åŠŸèƒ½:** æŠ–éŸ³è§†é¢‘çˆ¬è™«æ ¸å¿ƒç±»

**å±æ€§:**
```javascript
headers                // ç­¾åæ‰€éœ€çš„User-Agent
douyinApiHeaders       // æŠ–éŸ³APIè¯·æ±‚å¤´ï¼ˆå«Cookieï¼‰
urlPatterns            // é¢„ç¼–è¯‘çš„URLæ­£åˆ™è¡¨è¾¾å¼æ•°ç»„
urlRegex               // URLåŒ¹é…æ­£åˆ™
videoIdCache           // LRUè§†é¢‘IDç¼“å­˜ï¼ˆ100æ¡ï¼‰
cacheMaxSize           // ç¼“å­˜æœ€å¤§å®¹é‡
```

**æ ¸å¿ƒæ–¹æ³•:**

| æ–¹æ³• | åŠŸèƒ½ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| `updateCookie(newCookie)` | ğŸ”¥åŠ¨æ€æ›´æ–°Cookie | string | boolean |
| `getCurrentCookie()` | è·å–å½“å‰Cookie | - | string |
| `getDouyinVideoId(url)` | URL â†’ Video ID | string | Promise\<string\> |
| `getVideoIdByShareUrl(url)` | çŸ­é“¾æ¥è§£æ | string | Promise\<string\> |
| `getDouyinVideoData(videoId)` | è·å–è§†é¢‘å…ƒæ•°æ® | string | Promise\<Object\> |
| `getDouyinNoWatermarkVideo(data)` | å¤šé‡å›é€€è·å–æ— æ°´å°é“¾æ¥ | Object | Promise\<Array\> |
| `getZjcdnDirectUrls(data)` | è·å–zjcdnç›´é“¾ | Object | Promise\<Array\> |
| `getDouyinImageUrls(data)` | è·å–å›¾ç‰‡é“¾æ¥ | Object | Promise\<Array\> |
| `getUserSecUidByShareUrl(url)` | ç”¨æˆ·ä¸»é¡µ â†’ sec_uid | string | Promise\<string\> |

**URLè§£æç­–ç•¥ (getDouyinVideoId):**
```javascript
ä¼˜å…ˆçº§é¡ºåº:
1. ç›´æ¥ä»URLæå–IDï¼ˆ19/18/17ä½æ•°å­—ï¼‰
2. å¤šç”¨æˆ·ä»£ç†å°è¯•çŸ­é“¾æ¥é‡å®šå‘
   â€¢ iPhone iOS 10/15/16
   â€¢ Android 12
   â€¢ Chrome Desktop
3. æ­£åˆ™æ¨¡å¼åŒ¹é…:
   â€¢ /(slides|video|note)/(\d+)/
   â€¢ /aweme_id[=:](\d+)/
   â€¢ /(\d{19})/
```

**æ— æ°´å°è§†é¢‘è·å–ç­–ç•¥ (getDouyinNoWatermarkVideo):**
```javascript
å¤šé‡å›é€€é“¾è·¯ï¼ˆä»é«˜åˆ°ä½ä¼˜å…ˆçº§ï¼‰:

ğŸ¥‡ ç¬¬ä¸€ä¼˜å…ˆï¼šzjcdnç›´é“¾
â”œâ”€ v5-dy-o-abtest.zjcdn.com
â”œâ”€ v3-dy-o.zjcdn.com
â””â”€ v6-dy-o.zjcdn.com

ğŸ¥ˆ ç¬¬äºŒä¼˜å…ˆï¼šaweme.snssdk.comæ¥å£
â””â”€ æœ€ç¨³å®šçš„å®˜æ–¹æ¥å£

ğŸ¥‰ ç¬¬ä¸‰ä¼˜å…ˆï¼šixigua.comå›é€€
â””â”€ è¥¿ç“œè§†é¢‘CDN

ğŸ“Š ç»“æœå¤„ç†:
â€¢ è°ƒè¯•æ¨¡å¼: è¿”å›æ‰€æœ‰å¯ç”¨é“¾æ¥
â€¢ ç”Ÿäº§æ¨¡å¼: ä»…è¿”å›æœ€ç¨³å®šçš„1ä¸ªé“¾æ¥
```

**LRUç¼“å­˜æœºåˆ¶ (_cacheVideoId):**
```javascript
â€¢ å®¹é‡: 100æ¡
â€¢ ç­–ç•¥: åˆ é™¤æœ€å°‘ä½¿ç”¨çš„ï¼ˆMapç¬¬ä¸€ä¸ªï¼‰
â€¢ ç›®çš„: å‡å°‘é‡å¤URLè§£æ
```

---

## ğŸ¯ å·¥å…·å‡½æ•°åº“

### **1. maskSensitiveInfo(str, type)**  
ğŸ“ ä½ç½®: `bin/index.js:6`

**åŠŸèƒ½:** æ•æ„Ÿä¿¡æ¯è„±æ•æ˜¾ç¤º

**å‚æ•°:**
- `str: string` - åŸå§‹å­—ç¬¦ä¸²
- `type: string` - ç±»å‹ (`'cookie'` æˆ–å…¶ä»–)

**è¿”å›:**
```javascript
// Cookieç±»å‹: æ˜¾ç¤ºå‰4+å4å­—ç¬¦
maskSensitiveInfo('sid_guard=abcde...', 'cookie')
// è¿”å›: "sid_****bcde"

// é€šç”¨ç±»å‹: æ˜¾ç¤ºå‰3+å3å­—ç¬¦
maskSensitiveInfo('secret123456', 'other')
// è¿”å›: "sec****456"
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - æ—¥å¿—è¾“å‡ºä¿æŠ¤

---

### **2. formatRemainingTime(seconds)**  
ğŸ“ ä½ç½®: `bin/index.js:23`

**åŠŸèƒ½:** å°†ç§’æ•°æ ¼å¼åŒ–ä¸ºæ˜“è¯»æ—¶é—´

**å‚æ•°:**
- `seconds: number` - å‰©ä½™ç§’æ•°

**è¿”å›:**
```javascript
formatRemainingTime(93665)  // "1å¤©2å°æ—¶1åˆ†é’Ÿ5ç§’"
formatRemainingTime(3661)   // "1å°æ—¶1åˆ†é’Ÿ1ç§’"
formatRemainingTime(0)      // "å·²è¿‡æœŸ"
formatRemainingTime(-100)   // "å·²è¿‡æœŸ"
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - CookieçŠ¶æ€æ˜¾ç¤º

---

### **3. checkSidGuardExpiry(sidGuard)**  
ğŸ“ ä½ç½®: `bin/index.js:43`

**åŠŸèƒ½:** æ£€æµ‹ `sid_guard` Cookie æ˜¯å¦è¿‡æœŸ

**å‚æ•°:**
- `sidGuard: string` - sid_guardå€¼ï¼ˆæ ¼å¼: `xxxxx123|1234567890|1234599999|GMT+8:00`ï¼‰

**è¿”å›å¯¹è±¡:**
```javascript
{
    isValid: boolean,        // æ˜¯å¦æœ‰æ•ˆ
    isExpired: boolean,      // æ˜¯å¦è¿‡æœŸ
    error: string | null,    // é”™è¯¯ä¿¡æ¯
    details: {
        sessionId: string,           // ä¼šè¯ID
        generateTimestamp: number,   // ç”Ÿæˆæ—¶é—´æˆ³
        expiryTimestamp: number,     // è¿‡æœŸæ—¶é—´æˆ³
        validitySeconds: number,     // æœ‰æ•ˆæœŸç§’æ•°
        gmtTime: string,             // GMTæ—¶åŒº
        currentTimestamp: number,    // å½“å‰æ—¶é—´æˆ³
        remainingSeconds: number,    // å‰©ä½™ç§’æ•°
        remainingTime: string        // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´
    }
}
```

**éªŒè¯é€»è¾‘:**
```javascript
1. åˆ†å‰²sid_guardä¸º4éƒ¨åˆ†ï¼ˆç”¨|åˆ†éš”ï¼‰
2. è§£æç”Ÿæˆæ—¶é—´æˆ³å’Œæœ‰æ•ˆæœŸç§’æ•°
3. è®¡ç®—è¿‡æœŸæ—¶é—´ = ç”Ÿæˆæ—¶é—´ + æœ‰æ•ˆæœŸ
4. æ¯”è¾ƒå½“å‰æ—¶é—´ä¸è¿‡æœŸæ—¶é—´
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - `/api/cookie-status` ç«¯ç‚¹

---

### **4. checkCookieSidGuardExpiry(cookieString)**  
ğŸ“ ä½ç½®: `src/index.js:205`

**åŠŸèƒ½:** ä»å®Œæ•´Cookieå­—ç¬¦ä¸²ä¸­æå–å¹¶æ£€æµ‹sid_guard

**å‚æ•°:**
- `cookieString: string` - å®Œæ•´Cookieå­—ç¬¦ä¸²

**å¤„ç†æµç¨‹:**
```javascript
1. æ­£åˆ™æå–: /sid_guard=([^;]+)/
2. URLè§£ç : decodeURIComponent()
3. è°ƒç”¨: checkSidGuardExpiry()
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - CookieéªŒè¯ä¸­é—´å±‚

---

### **5. isDebugMode(req)**  
ğŸ“ ä½ç½®: `src/index.js:55`

**åŠŸèƒ½:** åˆ¤æ–­è¯·æ±‚æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼

**æ£€æŸ¥é¡ºåº:**
1. è¯·æ±‚ä½“: `req.body.debug == 1` æˆ– `req.body.debug === true`
2. æŸ¥è¯¢å‚æ•°: `req.query.debug == 1`
3. ç¯å¢ƒå˜é‡: `DEBUG_VIDEO_URLS === '1'`
4. ç¯å¢ƒå˜é‡: `DEBUG === '1'`

**å½±å“:**
- `true`: è¿”å›æ‰€æœ‰å¯ç”¨è§†é¢‘é“¾æ¥ï¼ˆå¤šä¸ªå›é€€ï¼‰
- `false`: ä»…è¿”å›æœ€ç¨³å®šçš„1ä¸ªé“¾æ¥

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨**

---

### **6. processDouyinVideo(url, debugMode)**  
ğŸ“ ä½ç½®: `src/index.js:63`

**åŠŸèƒ½:** æ ¸å¿ƒè§†é¢‘å¤„ç†é€»è¾‘ï¼ˆé‡æ„åçš„ç»Ÿä¸€å…¥å£ï¼‰

**å‚æ•°:**
- `url: string` - æŠ–éŸ³è§†é¢‘/å›¾ç‰‡åˆ†äº«é“¾æ¥
- `debugMode: boolean` - è°ƒè¯•æ¨¡å¼å¼€å…³

**å¤„ç†æµç¨‹:**
```
1. è§£æVideoID
   â””â”€> scraper.getDouyinVideoId(url)

2. è·å–è§†é¢‘å…ƒæ•°æ®
   â””â”€> scraper.getDouyinVideoData(videoId)

3. åˆ¤æ–­åª’ä½“ç±»å‹
   â”œâ”€ media_type=2 æˆ– 42 â†’ å›¾ç‰‡åˆ†äº«
   â””â”€ å…¶ä»– â†’ è§†é¢‘åˆ†äº«

4. è·å–æ— æ°´å°é“¾æ¥
   â””â”€> scraper.getDouyinNoWatermarkVideo(videoData)

5. å¤„ç†è¿”å›ç»“æœ
   â”œâ”€ è°ƒè¯•æ¨¡å¼: è¿”å›æ‰€æœ‰é“¾æ¥
   â””â”€ ç”Ÿäº§æ¨¡å¼: ä»…è¿”å›æœ€ç¨³å®šçš„1ä¸ª
```

**è¿”å›æ ¼å¼:**
```javascript
{
    code: 0,
    data: {
        video: [...],       // è§†é¢‘é“¾æ¥æ•°ç»„
        img: [...],         // å›¾ç‰‡é“¾æ¥æ•°ç»„
        debugMode: false,   // è°ƒè¯•æ¨¡å¼çŠ¶æ€
        isImagesShare: false // æ˜¯å¦ä¸ºå›¾ç‰‡åˆ†äº«
    }
}
```

**çŠ¶æ€:** âœ… **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨** - `/zjcdn` å’Œ `/workflow` ç«¯ç‚¹æ ¸å¿ƒé€»è¾‘

---

## ğŸŒ API ç«¯ç‚¹è¯¦è§£

### **ä¸»è¦ç«¯ç‚¹ (Production Endpoints)**

#### **1. POST /zjcdn** ğŸ¥‡  
ğŸ“ ä½ç½®: `src/index.js:296`  
**åŠŸèƒ½:** ä¸»è§†é¢‘è§£æç«¯ç‚¹ï¼ˆæœ€ç¨³å®šï¼Œæ¨èä½¿ç”¨ï¼‰

**ç‰¹ç‚¹:**
- âœ… è¯·æ±‚å»é‡ (RequestDeduplicator)
- âœ… å“åº”ç¼“å­˜ (SimpleCache - 2åˆ†é’Ÿ)
- âœ… æ€§èƒ½ç›‘æ§ (PerformanceMonitor)
- âœ… è°ƒè¯•æ¨¡å¼æ”¯æŒ

**è¯·æ±‚:**
```json
POST /zjcdn
Content-Type: application/json

{
    "url": "https://v.douyin.com/iFhnRsJm/",
    "debug": 0  // å¯é€‰: 1=è°ƒè¯•æ¨¡å¼
}
```

**å“åº” (æˆåŠŸ):**
```json
{
    "code": 0,
    "data": {
        "video": ["https://v5-dy-o-abtest.zjcdn.com/..."],
        "img": [],
        "debugMode": false,
        "isImagesShare": false
    }
}
```

**å“åº” (å›¾ç‰‡åˆ†äº«):**
```json
{
    "code": 0,
    "data": {
        "video": [],
        "img": [
            "https://p3-sign.douyinpic.com/...",
            "https://p6-sign.douyinpic.com/..."
        ],
        "debugMode": false,
        "isImagesShare": true
    }
}
```

**é”™è¯¯å¤„ç†:**
```json
{
    "code": -1,
    "msg": "é”™è¯¯ä¿¡æ¯",
    "error": "è¯¦ç»†é”™è¯¯æè¿°"
}
```

**æ€§èƒ½:**
- ç¼“å­˜å‘½ä¸­: ~5ms
- é¦–æ¬¡è¯·æ±‚: ~300-500ms
- å»é‡å‘½ä¸­: è¿”å›å…±äº«Promise

---

#### **2. POST /workflow** ğŸ”„  
ğŸ“ ä½ç½®: `src/index.js:514`  
**åŠŸèƒ½:** å¤šé‡å›é€€å¤‡ç”¨ç«¯ç‚¹

**å›é€€é“¾è·¯:**
```
1. å°è¯• processDouyinVideo()
   â”œâ”€ æˆåŠŸ â†’ è¿”å›ç»“æœ
   â””â”€ å¤±è´¥ â†“
   
2. å›é€€åˆ° zjcdn å¤šé‡å°è¯•
   â”œâ”€ æå–video_id
   â”œâ”€ å°è¯•æ‰€æœ‰zjcdnå˜ä½“
   â””â”€ è¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸçš„
```

**ä½¿ç”¨åœºæ™¯:**
- zjcdnä¸»ç«¯ç‚¹å¤±è´¥æ—¶çš„åå¤‡æ–¹æ¡ˆ
- éœ€è¦æ›´æ¿€è¿›çš„é‡è¯•ç­–ç•¥
- å‰ç«¯è‡ªåŠ¨å›é€€é€»è¾‘

**è¯·æ±‚/å“åº”:** ä¸ `/zjcdn` ç›¸åŒ

---

#### **3. POST /douyin** ğŸ”§  
ğŸ“ ä½ç½®: `src/index.js:502`  
**åŠŸèƒ½:** æ—§ç‰ˆå…¼å®¹ç«¯ç‚¹ï¼ˆä¸æ¨èï¼‰

**çŠ¶æ€:** âš ï¸ **å·²å¼ƒç”¨** - è¯·ä½¿ç”¨ `/zjcdn` æ›¿ä»£

---

### **ä»£ç†ä¸‹è½½ç«¯ç‚¹**

#### **4. GET /proxy-download** ğŸ“¥  
ğŸ“ ä½ç½®: `src/index.js:559`  
**åŠŸèƒ½:** æœåŠ¡ç«¯ä»£ç†ä¸‹è½½ï¼ˆè§£å†³CORSå’Œ403é—®é¢˜ï¼‰

**è¯·æ±‚:**
```
GET /proxy-download?url=<encoded_url>
```

**ç‰¹ç‚¹:**
- âœ… æµå¼ä¼ è¾“ (pipeline)
- âœ… è‡ªåŠ¨æ–‡ä»¶å
- âœ… CORSå¤´æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†

**å·¥ä½œæµç¨‹:**
```
1. è§£ç URLå‚æ•°
2. å‘èµ·HEADè¯·æ±‚è·å–Content-Type
3. æ ¹æ®Content-Typeè®¾ç½®æ–‡ä»¶å
   â”œâ”€ video/mp4 â†’ video.mp4
   â”œâ”€ image/jpeg â†’ image.jpg
   â””â”€ å…¶ä»– â†’ media
4. æµå¼ä¸‹è½½åˆ°å®¢æˆ·ç«¯
```

**å“åº”å¤´:**
```
Content-Disposition: attachment; filename="video.mp4"
Content-Type: video/mp4
Access-Control-Allow-Origin: *
```

**é”™è¯¯ç :**
- `400` - ç¼ºå°‘URLå‚æ•°
- `500` - ä¸‹è½½å¤±è´¥

---

#### **5. GET /proxy-video** ğŸ¬  
ğŸ“ ä½ç½®: `src/index.js:649`  
**åŠŸèƒ½:** è§†é¢‘æµä»£ç†ï¼ˆæ”¯æŒrangeè¯·æ±‚ï¼‰

**è¯·æ±‚:**
```
GET /proxy-video?url=<encoded_url>
```

**ç‰¹ç‚¹:**
- âœ… Rangeè¯·æ±‚æ”¯æŒï¼ˆè§†é¢‘æ‹–åŠ¨ï¼‰
- âœ… æ­£ç¡®çš„Content-Typeä¼ é€’
- âœ… æµå¼ä¼ è¾“

**ä½¿ç”¨åœºæ™¯:**
- HTML5 videoæ ‡ç­¾æ’­æ”¾
- è§†é¢‘é¢„è§ˆåŠŸèƒ½

---

### **Cookieç®¡ç†ç«¯ç‚¹**

#### **6. POST /api/update-cookie** ğŸª  
ğŸ“ ä½ç½®: `src/index.js:755`  
**åŠŸèƒ½:** åŠ¨æ€æ›´æ–°Cookieï¼ˆæ— éœ€é‡æ–°éƒ¨ç½²ï¼‰

**è¯·æ±‚:**
```json
POST /api/update-cookie
Content-Type: application/json

{
    "cookie": "sid_guard=xxxxx123|1234567890|1234599999|GMT+8:00",
    "updateVercelEnv": true  // å¯é€‰: åŒæ­¥åˆ°Vercelç¯å¢ƒå˜é‡
}
```

**å¤„ç†æµç¨‹:**
```
1. éªŒè¯Cookieæ ¼å¼
   â”œâ”€ æ£€æŸ¥sid_guardå‚æ•°
   â””â”€ URLè§£ç 

2. æ›´æ–°æœ¬åœ°Scraperå®ä¾‹
   â””â”€> scraper.updateCookie()

3. å¯é€‰: åŒæ­¥åˆ°Vercel (å¦‚æœé…ç½®äº†)
   â”œâ”€ æ£€æŸ¥Vercelé…ç½®
   â”œâ”€ æ›´æ–°ç¯å¢ƒå˜é‡
   â””â”€ é‡æ–°éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

4. éªŒè¯æ–°Cookieæœ‰æ•ˆæ€§
   â””â”€> checkSidGuardExpiry()
```

**å“åº” (æˆåŠŸ):**
```json
{
    "success": true,
    "message": "Cookieå·²æˆåŠŸæ›´æ–°",
    "validation": {
        "isValid": true,
        "remainingTime": "54å¤©23å°æ—¶"
    },
    "vercel": {
        "updated": true,
        "message": "ç¯å¢ƒå˜é‡å·²æ›´æ–°"
    }
}
```

**VercelåŒæ­¥è¦æ±‚:**
```bash
# å¿…éœ€çš„ç¯å¢ƒå˜é‡
VERCEL_TOKEN=your_token
VERCEL_PROJECT_ID=prj_xxx
VERCEL_TEAM_ID=team_xxx  # å¯é€‰
```

---

#### **7. GET /api/cookie-status** ğŸ“Š  
ğŸ“ ä½ç½®: `src/index.js:887`  
**åŠŸèƒ½:** æ£€æŸ¥CookieçŠ¶æ€ï¼ˆå®æ—¶ï¼‰

**è¯·æ±‚:**
```
GET /api/cookie-status
```

**å“åº”:**
```json
{
    "success": true,
    "message": "Cookie çŠ¶æ€æ­£å¸¸",
    "sidGuardStatus": {
        "isValid": true,
        "isExpired": false,
        "error": null,
        "remainingTime": "54å¤©23å°æ—¶59åˆ†é’Ÿ",
        "remainingSeconds": 4752000
    },
    "cookieInfo": {
        "source": "environment",  // "environment" | "scraper"
        "hasCookie": true,
        "cookiePreview": "sid_****a6df",
        "isPlaceholder": false
    }
}
```

**å“åº” (è¿‡æœŸ):**
```json
{
    "success": false,
    "message": "Cookie å·²è¿‡æœŸæˆ–æ— æ•ˆ",
    "sidGuardStatus": {
        "isValid": false,
        "isExpired": true,
        "error": "sid_guard å·²è¿‡æœŸ 1234 ç§’",
        "remainingTime": null,
        "remainingSeconds": -1234
    }
}
```

**å‰ç«¯è½®è¯¢:**
```javascript
// å‰ç«¯CookieManagerè‡ªåŠ¨è½®è¯¢
åŠ¨æ€é—´éš”:
â€¢ æ­£å¸¸çŠ¶æ€: æ¯5åˆ†é’Ÿæ£€æŸ¥
â€¢ å³å°†è¿‡æœŸ (<1å°æ—¶): æ¯2åˆ†é’Ÿæ£€æŸ¥
â€¢ å·²è¿‡æœŸ/é”™è¯¯: æ¯1åˆ†é’Ÿæ£€æŸ¥
```

---

#### **8. GET /api/vercel-config** âš™ï¸  
ğŸ“ ä½ç½®: `src/index.js:983`  
**åŠŸèƒ½:** è·å–Vercelé…ç½®çŠ¶æ€

**è¯·æ±‚:**
```
GET /api/vercel-config
```

**å“åº” (å·²é…ç½®):**
```json
{
    "success": true,
    "config": {
        "isConfigured": true,
        "available": true,
        "hasToken": true,
        "hasProjectId": true
    },
    "instructions": {
        "vercelToken": "åœ¨Vercel Dashboard > Settings > Tokensä¸­åˆ›å»º",
        "projectId": "åœ¨é¡¹ç›®Settings > Generalä¸­æ‰¾åˆ°Project ID",
        "teamId": "å¦‚æœé¡¹ç›®å±äºå›¢é˜Ÿï¼Œåœ¨å›¢é˜Ÿè®¾ç½®ä¸­æ‰¾åˆ°Team ID"
    }
}
```

**å“åº” (æœªé…ç½®):**
```json
{
    "success": true,
    "config": {
        "isConfigured": false,
        "available": false,
        "hasToken": false,
        "hasProjectId": false
    },
    "instructions": { ... }
}
```

---

### **è°ƒè¯•ç«¯ç‚¹ (Debug Endpoints)**

#### **9. POST /test-url** ğŸ”  
ğŸ“ ä½ç½®: `src/index.js:388`  
**åŠŸèƒ½:** å®Œæ•´URLè§£æè°ƒè¯•ï¼ˆå«æ‰€æœ‰å…ƒæ•°æ®ï¼‰

**ç”¨é€”:**
- è°ƒè¯•URLè§£æé—®é¢˜
- æŸ¥çœ‹å®Œæ•´è§†é¢‘å…ƒæ•°æ®
- è·å–æ‰€æœ‰å¯ç”¨é“¾æ¥

**è¯·æ±‚:**
```json
POST /test-url
Content-Type: application/json

{
    "url": "https://v.douyin.com/iFhnRsJm/"
}
```

**å“åº”:**
```json
{
    "success": true,
    "url": "https://v.douyin.com/iFhnRsJm/",
    "videoId": "7123456789012345678",
    "videoData": {
        "aweme_detail": {
            "aweme_id": "7123456789012345678",
            "desc": "è§†é¢‘æ ‡é¢˜",
            "author": {
                "nickname": "ä½œè€…æ˜µç§°",
                "uid": "123456"
            },
            "media_type": 4,
            "video": { ... },
            "statistics": { ... }
        }
    },
    "noWatermarkUrls": [
        "https://v5-dy-o-abtest.zjcdn.com/...",
        "https://aweme.snssdk.com/aweme/v1/play/...",
        "https://v26-web.douyinvod.com/..."
    ],
    "urlCount": 3,
    "processingTime": "342ms"
}
```

**çŠ¶æ€:** âœ… **å¼€å‘è°ƒè¯•ä½¿ç”¨**

---

#### **10. POST /check-url** âš¡  
ğŸ“ ä½ç½®: `src/index.js:430`  
**åŠŸèƒ½:** å¿«é€ŸURLéªŒè¯ï¼ˆä¸è·å–å®Œæ•´æ•°æ®ï¼‰

**ç”¨é€”:**
- å¿«é€Ÿæ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
- ä¸éœ€è¦è§†é¢‘æ•°æ®çš„åœºæ™¯
- é™ä½æœåŠ¡å™¨è´Ÿè½½

**è¯·æ±‚:**
```json
POST /check-url
Content-Type: application/json

{
    "url": "https://v.douyin.com/iFhnRsJm/"
}
```

**å“åº” (æˆåŠŸ):**
```json
{
    "success": true,
    "valid": true,
    "url": "https://v.douyin.com/iFhnRsJm/",
    "videoId": "7123456789012345678",
    "message": "URLæœ‰æ•ˆï¼ŒvideoIdè§£ææˆåŠŸ"
}
```

**å“åº” (å¤±è´¥):**
```json
{
    "success": false,
    "valid": false,
    "url": "https://invalid-url",
    "error": "æ— æ³•ä»ä»»ä½•ç”¨æˆ·ä»£ç†è·å–videoId",
    "message": "URLæ— æ•ˆæˆ–å·²è¿‡æœŸ"
}
```

**æ€§èƒ½å¯¹æ¯”:**
- `/check-url`: ~100-200ms (åªè§£æID)
- `/test-url`: ~300-500ms (è·å–å®Œæ•´æ•°æ®)

---

#### **11. POST /test-videoid** ğŸ¯  
ğŸ“ ä½ç½®: `src/index.js:473`  
**åŠŸèƒ½:** ç›´æ¥æµ‹è¯•Video IDï¼ˆç»•è¿‡URLè§£æï¼‰

**ç”¨é€”:**
- å·²çŸ¥Video IDæ—¶è·³è¿‡è§£æ
- è°ƒè¯•ç‰¹å®šè§†é¢‘é—®é¢˜
- æµ‹è¯•APIå“åº”

**è¯·æ±‚:**
```json
POST /test-videoid
Content-Type: application/json

{
    "videoId": "7123456789012345678"
}
```

**å“åº”:**
```json
{
    "success": true,
    "videoId": "7123456789012345678",
    "videoData": { ... },
    "noWatermarkUrls": [ ... ],
    "urlCount": 3
}
```

**çŠ¶æ€:** âœ… **å¼€å‘è°ƒè¯•ä½¿ç”¨**

---

#### **12. GET /readme** ğŸ“–  
ğŸ“ ä½ç½®: `src/index.js:278`  
**åŠŸèƒ½:** README.mdæ¸²æŸ“ï¼ˆHTMLæ ¼å¼ï¼‰

**ç‰¹ç‚¹:**
- âœ… 5åˆ†é’Ÿç¼“å­˜
- âœ… Markdown â†’ HTML (ä½¿ç”¨markedåº“)
- âœ… GitHubæ ·å¼CSS

**è¯·æ±‚:**
```
GET /readme
```

**å“åº”:** HTMLé¡µé¢

---

## ğŸ¨ å‰ç«¯æ ¸å¿ƒç±»

### ğŸ“¦ æ–‡ä»¶: `public/script.js` (2819è¡Œ)

#### **1. DownloadManager**  
ğŸ“ ä½ç½®: `public/script.js:878`

**åŠŸèƒ½:** ä¸‹è½½é˜Ÿåˆ—ç®¡ç†å’ŒçŠ¶æ€è·Ÿè¸ª

**å±æ€§:**
```javascript
queue: Array              // ä¸‹è½½ä»»åŠ¡é˜Ÿåˆ—
inProgress: boolean       // æ˜¯å¦æ­£åœ¨ä¸‹è½½
maxConcurrent: 3          // æœ€å¤§å¹¶å‘æ•°
activeDownloads: Map      // æ´»åŠ¨ä¸‹è½½æ˜ å°„
completed: number         // å·²å®Œæˆæ•°
failed: number            // å¤±è´¥æ•°
statistics: Object        // ç»Ÿè®¡ä¿¡æ¯
retryAttempts: 3          // é‡è¯•æ¬¡æ•°
downloadDelay: 500ms      // ä¸‹è½½é—´éš”
```

**äº‹ä»¶:**
```javascript
'download-start'      // å¼€å§‹ä¸‹è½½
'download-progress'   // ä¸‹è½½è¿›åº¦æ›´æ–°
'download-complete'   // å•ä¸ªä¸‹è½½å®Œæˆ
'download-error'      // ä¸‹è½½é”™è¯¯
'queue-complete'      // é˜Ÿåˆ—å®Œæˆ
```

**æ ¸å¿ƒæ–¹æ³•:**
```javascript
addToQueue(task)          // æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
processQueue()            // å¤„ç†é˜Ÿåˆ—
downloadFile(task)        // ä¸‹è½½å•ä¸ªæ–‡ä»¶
retryDownload(task)       // é‡è¯•ä¸‹è½½
pause()                   // æš‚åœä¸‹è½½
resume()                  // æ¢å¤ä¸‹è½½
cancel()                  // å–æ¶ˆæ‰€æœ‰
```

**ä½¿ç”¨åœºæ™¯:** æ‰¹é‡ä¸‹è½½ã€ä¸‹è½½ç®¡ç†

---

#### **2. DownloadUI**  
ğŸ“ ä½ç½®: `public/script.js:1195`

**åŠŸèƒ½:** æ‰¹é‡ä¸‹è½½ç•Œé¢æ§åˆ¶

**å±æ€§:**
```javascript
modal: HTMLElement        // æ¨¡æ€æ¡†å…ƒç´ 
progressBar: HTMLElement  // è¿›åº¦æ¡
statusText: HTMLElement   // çŠ¶æ€æ–‡æœ¬
itemsList: HTMLElement    // é¡¹ç›®åˆ—è¡¨
```

**æ–¹æ³•:**
```javascript
show()                    // æ˜¾ç¤ºç•Œé¢
hide()                    // éšè—ç•Œé¢
updateProgress(percent)   // æ›´æ–°è¿›åº¦
addItem(item)             // æ·»åŠ ä¸‹è½½é¡¹
updateItemStatus(id, status)  // æ›´æ–°é¡¹çŠ¶æ€
```

---

#### **3. CookieManager**  
ğŸ“ ä½ç½®: `public/script.js:2104`

**åŠŸèƒ½:** CookieçŠ¶æ€ç›‘æ§å’Œæ›´æ–°UI

**æ ¸å¿ƒåŠŸèƒ½:**
1. **å®æ—¶çŠ¶æ€ç›‘æ§**
   - åŠ¨æ€è½®è¯¢é—´éš”ï¼ˆ1-5åˆ†é’Ÿï¼‰
   - å‰©ä½™æ—¶é—´æ˜¾ç¤º
   - è¿‡æœŸæé†’

2. **Cookieæ›´æ–°**
   - æ™ºèƒ½æ ¼å¼éªŒè¯
   - Vercelç¯å¢ƒåŒæ­¥
   - ç«‹å³ç”Ÿæ•ˆ

3. **çŠ¶æ€æ˜¾ç¤º**
   - åœ†å½¢æ‚¬æµ®æŒ‰é’®
   - æ¨¡æ€æ¡†è¯¦ç»†ä¿¡æ¯
   - Toasté€šçŸ¥

**æ–¹æ³•:**
```javascript
openModal()               // æ‰“å¼€Cookieç®¡ç†
closeModal()              // å…³é—­æ¨¡æ€æ¡†
saveCookie()              // ä¿å­˜æ–°Cookie
checkSidGuardStatus()     // æ£€æŸ¥çŠ¶æ€
refreshStatus()           // åˆ·æ–°æ˜¾ç¤º
updateStatusDisplay()     // æ›´æ–°UI
initStatusCheck()         // åˆå§‹åŒ–è½®è¯¢
```

**è½®è¯¢ç­–ç•¥:**
```javascript
çŠ¶æ€          | è½®è¯¢é—´éš”
-------------|----------
æ­£å¸¸ (>1å°æ—¶)  | 5åˆ†é’Ÿ
è­¦å‘Š (<1å°æ—¶)  | 2åˆ†é’Ÿ
é”™è¯¯/è¿‡æœŸ     | 1åˆ†é’Ÿ
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

### **1. è¯·æ±‚å»é‡ (Request Deduplication)**
```
åœºæ™¯: 100ä¸ªå¹¶å‘è¯·æ±‚ç›¸åŒURL
ä¼ ç»Ÿæ–¹å¼: 100æ¬¡APIè°ƒç”¨ â†’ æœåŠ¡å™¨å‹åŠ›å¤§
ä¼˜åŒ–å: 1æ¬¡APIè°ƒç”¨ + 99æ¬¡Promiseå…±äº« â†’ å‡å°‘99%è´Ÿè½½
```

### **2. å“åº”ç¼“å­˜ (Response Caching)**
```
TTL: 120ç§’ï¼ˆ2åˆ†é’Ÿï¼‰
åœºæ™¯: ç”¨æˆ·é‡å¤è§£æåŒä¸€è§†é¢‘
æ•ˆæœ: ç¼“å­˜å‘½ä¸­ç‡ ~40% â†’ å“åº”æ—¶é—´ä»500msé™è‡³5ms
```

### **3. LRUç¼“å­˜ (Video ID Cache)**
```
å®¹é‡: 100æ¡
å‘½ä¸­ç‡: ~60%
æ•ˆæœ: å‡å°‘URLé‡å®šå‘è¯·æ±‚
```

### **4. è½®è¯¢æ¸…ç† (Round-robin Cleanup)**
```
ç­–ç•¥: æ¯æ¬¡æ£€æŸ¥50æ¡ï¼Œåˆ†æ‰¹æ¸…ç†
æ•ˆæœ: é˜²æ­¢å¤§ç¼“å­˜æ¸…ç†æ—¶çš„é˜»å¡
```

### **5. æ€§èƒ½ç›‘æ§ (Performance Monitoring)**
```bash
# å¯ç”¨ç›‘æ§
ENABLE_PERF_MONITORING=1

# æ—¥å¿—è¾“å‡º
â±ï¸ [zjcdn-api] Duration: 342ms, Memory: 1.23MB heap
```

---

## ğŸ” Cookie ç®¡ç†ç³»ç»Ÿ

### **Cookieç”Ÿå‘½å‘¨æœŸ**

```
1. å¯åŠ¨æ£€æµ‹
   â”œâ”€ è¯»å–ç¯å¢ƒå˜é‡ DOUYIN_COOKIE
   â”œâ”€ éªŒè¯sid_guardæœ‰æ•ˆæœŸ
   â””â”€ è¾“å‡º: ğŸª DOUYIN_COOKIE loaded: sid_****a6df

2. è¿è¡Œæ—¶ç›‘æ§
   â”œâ”€ å‰ç«¯: CookieManager å®šæœŸè½®è¯¢
   â”œâ”€ åç«¯: /api/cookie-status å®æ—¶æ£€æŸ¥
   â””â”€ åŠ¨æ€è°ƒæ•´æ£€æŸ¥é¢‘ç‡

3. è¿‡æœŸæé†’
   â”œâ”€ å‰©ä½™ <1å°æ—¶: è­¦å‘ŠçŠ¶æ€ (âš ï¸)
   â”œâ”€ å·²è¿‡æœŸ: é”™è¯¯çŠ¶æ€ (âŒ)
   â””â”€ Toasté€šçŸ¥ + æ‚¬æµ®æŒ‰é’®å˜è‰²

4. åŠ¨æ€æ›´æ–°
   â”œâ”€ POST /api/update-cookie
   â”œâ”€ scraper.updateCookie() ç«‹å³ç”Ÿæ•ˆ
   â””â”€ å¯é€‰: åŒæ­¥åˆ°Vercelç¯å¢ƒå˜é‡

5. VercelåŒæ­¥
   â”œâ”€ æ›´æ–°ç¯å¢ƒå˜é‡
   â”œâ”€ å¯é€‰è§¦å‘é‡æ–°éƒ¨ç½²
   â””â”€ ç¡®ä¿å¤šå®ä¾‹ä¸€è‡´æ€§
```

### **sid_guard æ ¼å¼**

```
æ ¼å¼: sessionId|generateTime|expiryTime|timezone
ç¤ºä¾‹: xxxxx123|1234567890|1234599999|GMT+8:00
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      ä¼šè¯ID    ç”Ÿæˆæ—¶é—´  è¿‡æœŸæ—¶é—´    æ—¶åŒº

è®¡ç®—: å‰©ä½™æ—¶é—´ = è¿‡æœŸæ—¶é—´ - å½“å‰æ—¶é—´
```

---

## ğŸ› è°ƒè¯•å·¥ä½œæµ

### **åœºæ™¯1: URLè§£æå¤±è´¥**

```
1. ä½¿ç”¨ /check-url å¿«é€ŸéªŒè¯
   â””â”€> ç¡®è®¤URLæ ¼å¼å’Œæœ‰æ•ˆæ€§

2. ä½¿ç”¨ /test-url æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
   â””â”€> è·å–å®Œæ•´å…ƒæ•°æ®å’Œé”™è¯¯æ ˆ

3. æ£€æŸ¥æ—¥å¿—è¾“å‡º
   â”œâ”€ å¤šç”¨æˆ·ä»£ç†å°è¯•è®°å½•
   â”œâ”€ æ­£åˆ™åŒ¹é…ç»“æœ
   â””â”€> videoIdæå–è¿‡ç¨‹

4. ç›´æ¥æµ‹è¯•Video ID
   â””â”€> /test-videoid (ç»•è¿‡URLè§£æ)
```

### **åœºæ™¯2: Cookieé—®é¢˜**

```
1. æ£€æŸ¥CookieçŠ¶æ€
   GET /api/cookie-status
   â””â”€> æŸ¥çœ‹å‰©ä½™æ—¶é—´å’Œæœ‰æ•ˆæ€§

2. æ›´æ–°Cookie
   POST /api/update-cookie
   â””â”€> åŠ¨æ€æ›´æ–°ï¼Œæ— éœ€é‡æ–°éƒ¨ç½²

3. éªŒè¯æ›´æ–°ç»“æœ
   â””â”€> å†æ¬¡è°ƒç”¨ /api/cookie-status
```

### **åœºæ™¯3: ä¸‹è½½403é”™è¯¯**

```
1. æ£€æŸ¥è¿”å›çš„URLç±»å‹
   â”œâ”€ zjcdnç›´é“¾ â†’ æœ€ç¨³å®š
   â”œâ”€ aweme.snssdk.com â†’ éœ€è¦Cookie
   â””â”€ ixigua.com â†’ å¤‡ç”¨æ–¹æ¡ˆ

2. ä½¿ç”¨ä»£ç†ä¸‹è½½
   GET /proxy-download?url=<encoded_url>
   â””â”€> æœåŠ¡ç«¯ä»£ç†ç»•è¿‡CORS

3. å¯ç”¨è°ƒè¯•æ¨¡å¼
   POST /zjcdn?debug=1
   â””â”€> è·å–æ‰€æœ‰å¯ç”¨é“¾æ¥ï¼Œé€ä¸ªæµ‹è¯•
```

---

## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯ (v2026.2.12)

### **ä»£ç é‡ç»Ÿè®¡**
```
bin/index.js:     678 è¡Œ (Scraperæ ¸å¿ƒ)
src/index.js:    1030 è¡Œ (ExpressæœåŠ¡å™¨)
public/script.js: 2819 è¡Œ (å‰ç«¯UI)
------------------------
æ€»è®¡:            4527 è¡Œ
```

### **APIç«¯ç‚¹æ€»æ•°**
```
ç”Ÿäº§ç«¯ç‚¹:  5ä¸ª (/zjcdn, /workflow, /douyin, /proxy-download, /proxy-video)
Cookieç®¡ç†: 3ä¸ª (/api/update-cookie, /api/cookie-status, /api/vercel-config)
è°ƒè¯•ç«¯ç‚¹:  3ä¸ª (/test-url, /check-url, /test-videoid)
æ–‡æ¡£ç«¯ç‚¹:  1ä¸ª (/readme)
------------------------
æ€»è®¡:     12ä¸ª
```

### **ç±»æ€»æ•°**
```
åç«¯ç±»: 4ä¸ª (PerformanceMonitor, SimpleCache, RequestDeduplicator, Scraper)
å‰ç«¯ç±»: 3ä¸ª (DownloadManager, DownloadUI, CookieManager)
------------------------
æ€»è®¡:  7ä¸ª
```

### **å·¥å…·å‡½æ•°**
```
æ•æ„Ÿä¿¡æ¯: maskSensitiveInfo
æ—¶é—´æ ¼å¼: formatRemainingTime
CookieéªŒè¯: checkSidGuardExpiry, checkCookieSidGuardExpiry
è°ƒè¯•åˆ¤æ–­: isDebugMode
è§†é¢‘å¤„ç†: processDouyinVideo
------------------------
æ€»è®¡:  6ä¸ªæ ¸å¿ƒå·¥å…·å‡½æ•°
```

---

## ğŸš€ æœ€ä½³å®è·µ

### **1. URLè§£æ**
```javascript
âœ… æ¨è: ä½¿ç”¨ /zjcdn ç«¯ç‚¹
âŒ é¿å…: ç›´æ¥ä½¿ç”¨ /douyin (å·²å¼ƒç”¨)
```

### **2. è°ƒè¯•**
```javascript
// å¼€å‘ç¯å¢ƒ
POST /test-url { "url": "..." }  // å®Œæ•´è°ƒè¯•ä¿¡æ¯

// ç”Ÿäº§ç¯å¢ƒ
POST /zjcdn { "url": "...", "debug": 0 }  // ä»…è¿”å›ç¨³å®šé“¾æ¥
```

### **3. Cookieç®¡ç†**
```javascript
// æ–¹å¼1: ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰
.env.local: DOUYIN_COOKIE=sid_guard=xxxxx123|...

// æ–¹å¼2: åŠ¨æ€æ›´æ–°ï¼ˆè¿è¡Œæ—¶ï¼‰
POST /api/update-cookie { "cookie": "sid_guard=xxxxx123|..." }

// æ–¹å¼3: Vercelè‡ªåŠ¨åŒæ­¥
é…ç½®VERCEL_TOKEN + VERCEL_PROJECT_ID
```

### **4. ä¸‹è½½ç­–ç•¥**
```javascript
// ç­–ç•¥1: ç›´æ¥ä¸‹è½½ï¼ˆä¼˜å…ˆï¼‰
downloadMedia(url)

// ç­–ç•¥2: ä»£ç†ä¸‹è½½ï¼ˆ403æ—¶ï¼‰
/proxy-download?url=<encoded_url>

// ç­–ç•¥3: å¤šé‡å›é€€ï¼ˆè‡ªåŠ¨ï¼‰
/workflow ç«¯ç‚¹è‡ªåŠ¨å°è¯•æ‰€æœ‰æ–¹æ¡ˆ
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

æŸ¥çœ‹ [CHANGELOG_v2026.2.12.md](./CHANGELOG_v2026.2.12.md) è·å–è¯¦ç»†æ›´æ–°è®°å½•ã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- ğŸ› **BugæŠ¥å‘Š:** ä½¿ç”¨ `/test-url` æ”¶é›†è¯¦ç»†ä¿¡æ¯
- ğŸ“Š **æ€§èƒ½é—®é¢˜:** å¯ç”¨ `ENABLE_PERF_MONITORING=1` æŸ¥çœ‹æ—¥å¿—
- ğŸª **Cookieé—®é¢˜:** æ£€æŸ¥ `/api/cookie-status` çŠ¶æ€
- ğŸ” **è°ƒè¯•æ¨¡å¼:** æ·»åŠ  `?debug=1` å‚æ•°æŸ¥çœ‹æ‰€æœ‰é“¾æ¥

---

**æ–‡æ¡£ç‰ˆæœ¬:** v2026.2.12  
**æœ€åæ›´æ–°:** 2026å¹´2æœˆ13æ—¥  
**æ–‡æ¡£ä½œè€…:** GitHub Copilot
