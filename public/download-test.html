<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹è½½åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { margin: 10px 5px; padding: 10px 15px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        #log { background: #f5f5f5; padding: 10px; margin: 10px 0; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>æŠ–éŸ³ä¸‹è½½åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•è§†é¢‘URL:</h3>
        <p><code id="test-url">https://aweme.snssdk.com/aweme/v1/play/?video_id=v0d00fg10000d2aq08vog65v0b58usm0&ratio=1080p&line=0</code></p>
        <p style="color: #666; font-size: 0.9em;">
            <strong>æ³¨æ„ï¼š</strong>å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºï¼š<br>
            1. æµ‹è¯•URLå·²è¿‡æœŸï¼ˆæŠ–éŸ³é“¾æ¥æœ‰æ—¶æ•ˆæ€§ï¼‰<br>
            2. éœ€è¦ä½¿ç”¨æ–°çš„æŠ–éŸ³åˆ†äº«é“¾æ¥è¿›è¡Œæµ‹è¯•<br>
            3. å¯ä»¥å°è¯•ç›´æ¥æµ‹è¯•videoIdåŠŸèƒ½
        </p>
        
        <button onclick="testGetRealUrl()">ğŸ” æµ‹è¯•è·å–çœŸå®URL</button>
        <button onclick="testZjcdnApi()">ğŸš€ æµ‹è¯•zjcdnç›´é“¾API</button>
        <button onclick="testDirectDownload()">â¬‡ï¸ æµ‹è¯•ç›´æ¥ä¸‹è½½</button>
        <button onclick="testVideoId()">ğŸ¯ æµ‹è¯•VideoIDï¼ˆç»•è¿‡URLè§£æï¼‰</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•æ—¥å¿—:</h3>
        <div id="log"></div>
    </div>

    <script>
        const testUrl = document.getElementById('test-url').textContent;
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            log.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            log.innerHTML = '';
        }
        
        async function testZjcdnApi() {
            addLog('ğŸš€ å¼€å§‹æµ‹è¯•zjcdnç›´é“¾API...');
            try {
                const response = await fetch('/zjcdn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: 'https://v.douyin.com/test/' }) // ä½¿ç”¨æµ‹è¯•URL
                });
                
                if (!response.ok) {
                    addLog('âŒ zjcdn APIè¯·æ±‚å¤±è´¥: ' + response.status, 'error');
                    return;
                }
                
                const result = await response.json();
                
                if (result.code === 0) {
                    addLog('âœ… zjcdn APIè°ƒç”¨æˆåŠŸ:', 'success');
                    addLog(`   æ–¹æ³•: ${result.data.method}`);
                    addLog(`   è§†é¢‘é“¾æ¥æ•°é‡: ${result.data.video.length}`);
                    addLog(`   å›¾ç‰‡é“¾æ¥æ•°é‡: ${result.data.img.length}`);
                    addLog(`   æ˜¯å¦å›¾ç‰‡åˆ†äº«: ${result.data.isImagesShare}`);
                    
                    if (result.data.video.length > 0) {
                        addLog('ğŸ“¹ è§†é¢‘é“¾æ¥:');
                        result.data.video.forEach((url, index) => {
                            const isZjcdn = url.includes('zjcdn.com');
                            addLog(`   ${index + 1}. ${isZjcdn ? '[ZJCDN]' : '[OTHER]'} ${url.substring(0, 80)}...`);
                        });
                    }
                    
                } else {
                    addLog('âŒ zjcdn APIè¿”å›é”™è¯¯: ' + result.msg, 'error');
                }
                
            } catch (error) {
                addLog('âŒ zjcdn APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testGetRealUrl() {
            addLog('ğŸ” å¼€å§‹æµ‹è¯•è·å–çœŸå®URL...');
            try {
                const response = await fetch(`/get-real-url?url=${encodeURIComponent(testUrl)}`);
                const result = await response.json();
                
                if (result.success) {
                    addLog('âœ… è·å–çœŸå®URLæˆåŠŸ:', 'success');
                    addLog(`   åŸå§‹URL: ${result.originalUrl.substring(0, 80)}...`);
                    addLog(`   çœŸå®URL: ${result.realUrl.substring(0, 80)}...`);
                    addLog(`   å†…å®¹ç±»å‹: ${result.headers.contentType}`);
                    addLog(`   æ–‡ä»¶å¤§å°: ${result.headers.contentLength} bytes`);
                    addLog(`   æ˜¯å¦é‡å®šå‘: ${result.redirected}`);
                } else {
                    addLog('âŒ è·å–çœŸå®URLå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testDirectDownload() {
            addLog('â¬‡ï¸ å¼€å§‹æµ‹è¯•ç›´æ¥ä¸‹è½½...');
            const filename = 'test_direct_video.mp4';
            
            try {
                // æµ‹è¯•ç›´æ¥ä¸‹è½½URL
                const directUrl = `/direct-download?${new URLSearchParams({
                    url: testUrl,
                    filename: filename
                })}`;
                
                addLog('ğŸ”— ç›´æ¥ä¸‹è½½URL: ' + directUrl);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = directUrl;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog('ğŸš€ ç›´æ¥ä¸‹è½½å·²è§¦å‘', 'success');
                
            } catch (error) {
                addLog('âŒ ç›´æ¥ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testVideoId() {
            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•VideoIDåŠŸèƒ½ï¼ˆç»•è¿‡URLè§£æï¼‰...');
            const testVideoId = '7000000000000000000'; // ç¤ºä¾‹videoId
            
            try {
                const response = await fetch('/test-videoid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: testVideoId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('âœ… VideoIDæµ‹è¯•æˆåŠŸ:', 'success');
                    addLog(`   VideoId: ${result.videoId}`);
                    addLog(`   æ ‡é¢˜: ${result.title}`);
                    addLog(`   ä½œè€…: ${result.author}`);
                    addLog(`   åª’ä½“ç±»å‹: ${result.mediaType}`);
                    addLog(`   åŒ…å«è§†é¢‘: ${result.hasVideo}`);
                    addLog(`   åŒ…å«å›¾ç‰‡: ${result.hasImages}`);
                } else {
                    addLog('âŒ VideoIDæµ‹è¯•å¤±è´¥: ' + result.error, 'error');
                }
                
            } catch (error) {
                addLog('âŒ VideoIDæµ‹è¯•å‡ºé”™: ' + error.message, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        addLog('ğŸ¬ æŠ–éŸ³ä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        addLog('ğŸ“ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•ä¸åŒçš„ä¸‹è½½æ–¹æ³•');
        addLog('ğŸ’¡ å¦‚æœURLæµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½æ˜¯é“¾æ¥è¿‡æœŸï¼Œå°è¯•ä½¿ç”¨VideoIDæµ‹è¯•éªŒè¯åŸºæœ¬åŠŸèƒ½');
    </script>
</body>
</html>
